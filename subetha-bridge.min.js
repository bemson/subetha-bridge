/* SubEtha-Bridge v0.0.4-alpha + Morus v1.0.0 | github.com/bemson | (c) 2014, APACHE & MIT */
!function(A,n,B,S){function r(){function r(){for(var d={},h=p.concat(),l,e,m,n=95;n--;)m=F(G()*n),e=n+32,l=h[m],d[e+"c"]=l,d[l]=e,h.splice(m,1);return d}function d(){this.randomize()}var n={},p=[],ka,A=JSON.stringify,m=JSON.parse,G=Math.random,F=Math.round,H=/[ -~]/g,B=/^(\d+)({.+})$/;!function(){for(var d=95,h,l;d--;)h=d+32,l=String.fromCharCode(h),n[h+"c"]=p[d]=l,n[l]=h;ka=p.join("")}();d.prototype.encode=function(d){var h=this.key,l=this.index,e;return d.replace(H,function(d){e=n[d];e-=32-l;e%=
95;e+=32;l++;return h[e+"c"]})};d.prototype.decode=function(d){var h=this.key,l=this.index,e;return d.replace(H,function(d){e=h[d];e-=32+l;0>e&&(e%=95)&&(e=95+e);e+=32;l++;return n[e+"c"]})};d.prototype.randomize=function(){this.key=r();this.index=F(95*G());return this};d.prototype.cipher=function(d){var h;return arguments.length?"string"==typeof d&&(h=B.exec(d))?(this.index=+h[1],this.key=m(h[2]),!0):!1:this.index+A(this.key)};d.genKey=r;d.ASCII=ka;return d}A?define(r):n?module.exports=r():B.Morus||
(B.Morus=r())}("function"==typeof define,"undefined"!=typeof exports,this);
!function(A,n,B,S,r,ha,d,Ha){function p(){function p(a){for(var b=1,c,g;c=arguments[b];b++)for(g in c)f.call(c,g)&&(a[g]=c[g]);return a}function la(a){var b=16*L()|0;return("x"===a?b:b&3|8).toString(16)}function m(a){return a&&"string"===typeof a}function G(){for(var a=[],b=~~(40*L());b--;)a.push(Aa(~~(90*L())));return a.join("")}function F(a){f.call(w,a)||(w[a]={},C[a]=0);return w[a]}function H(a,b){s.setItem("se-0-msg",Ba+na+M({type:a,bid:N,msg:b}))}function ma(a,b){var c=0,g;if(!b){c=a.from;if(!f.call(u,
c))return;b=u[a.from].channel;c=!f.call(q,c)}T();g=t[b];if(!(c=!a.to&&(c&&g||!c&&1<g))&&(c=a.to))a:{c=a.to;for(g=c.length;g--;)if(f.call(q,c[g])){c=1;break a}c=0}c&&v("client",a)}function v(a,b,c){Ca(["se-0",D,I.encode(G()+M({mid:"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(oa,la),type:a,sent:c||new r,msg:b})+G())]);I.shift++}function h(a){var b=a.allow,c=a.deny,g=a.ignore,d=1;a.allow=function(){return d?(d=0,l(a,c,arguments),!0):!1};a.deny=function(){return d?(d=0,l(a,b,arguments),!0):!1};a.ignore=
function(){return d?(d=0,l(a,g,arguments),!0):!1}}function l(a,b,c){return c.length?b.apply(a,c):b.call(a)}function e(){U=0;pa(ia())}function ia(){var a;!U&&V.length&&(U=1,a=new qa(V.shift()),f.call(k,"_evts")&&f.call(k._evts,"relay")&&k._evts.relay.length?(h(a),k.pendingRelay=a,k.fire("relay",a)):a.allow())}function ja(a){f.call(x,a.id)&&k.fire("join",a)}function W(a,b){b[a.id]=a;clearTimeout(X);X=setTimeout(T,5)}function T(a){var b=x,c=O,g=[],d=[],f,e,h;clearTimeout(X);x={};O={};for(f in b)e=b[f],
g.push(e),ja(e);for(f in c)e=c[f],d.push({id:f,channel:e.channel}),k.fire("drop",e);if(g.length||d.length){c=[];for(h in w)for(f in b=w[h],b)c.push(b[f]);s.setItem("se-0-net",M(c));g={joins:g,drops:d};H("net",g);a||v("net",g)}}function Y(a){a=a.client.id;f.call(y,a)&&delete y[a]}function Z(a,b){var c=a.id,g=a.channel;u[c]=(b||F(g))[c]=a;C[g]++;$++;return a}function aa(a){var b=a.channel;a=a.id;delete u[a];$--;1===C[b]?(delete w[b],delete C[b]):(delete w[b][a],C[b]--)}function ra(a){var b=a.id;a=a.channel;
delete q[b];delete x[b];1===t[a]?(delete J[a],delete t[a]):(delete J[a][b],t[a]--)}function sa(a){var b=a.data,c=typeof b,g,d=0;na=a.timeStamp;if(!ba&&"string"===c)if(ta.test(b))try{b=ca(b),d=1}catch(e){return}else return;else if("object"!==c)return;if((d||b.key===z&&m(b.mid)&&f.call(b,"msg"))&&f.call(ua,g=b.type))ua[g](b,a)}function va(a){var b=a.newValue;if("se-0-msg"==a.key&&"string"==typeof b&&Da.test(b)){b=b.substring(b.indexOf("{"));try{b=ca(b)}catch(c){return}if("object"===typeof b&&f.call(b,
"msg")&&f.call(wa,b.type))wa[b.type](b.msg)}}function xa(a){k.init(a.data)}function ya(a,b){this.client=a;this.credentials=a.creds;this.mid=b;delete a.creds}function qa(a){this.sent=a.sent;this.msg=a.msg}function E(a){a&&(this.id=a.id,this.channel=a.channel,this.origin=a.origin)}function da(a){E.call(this,a);this.start=new r;this.bid=N}function ea(a){E.call(this,a);this.start=new r(a.start);this.bid=a.bid}var I=new (n||A?require("morus"):d.Morus),M=JSON.stringify,ca=JSON.parse,s=B,L=ha.random,Aa=
String.fromCharCode,Ea=S.prototype.slice,f=Object.prototype.hasOwnProperty,za,oa=/[xy]/g,N="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(oa,la),D,fa=0,K=0,na,P=d.parent,z,ta,Da=/se-0`[0-9a-f-]{36}`\d+\{.+\}$/,Fa=location.origin||location.protocol+"//"+(location.port?location.port+":":"")+location.hostname,Ba="se-0`"+N+"`",ga=P===d||"function"!=typeof P.postMessage||"object"!=typeof s||"function"!=typeof s.getItem||"function"!=typeof s.setItem,u={},$=0,w={},C={},y={},q={},Ga=0,J={},t={},O={},x={},
X,V=[],U=0,ba=!!function(){var a=1;try{d.postMessage({toString:function(){a=0}},"*")}catch(b){}return a}(),Ca=ba?function(a){P.postMessage(a,"*")}:function(a){P.postMessage(M(a),"*")},pa="function"===typeof setImmediate&&setImmediate||n&&process.nextTick||function(a){setTimeout(a,0)},Q=d.attachEvent?function(a,b,c){a.attachEvent("on"+b,c)}:function(a,b,c){a.addEventListener(b,c,!1)},R=d.attachEvent?function(a,b,c){a.detachEvent("on"+b,c)}:function(a,b,c){a.removeEventListener(b,c,!1)},ua={client:function(a,
b){var c=a.msg;"object"===typeof c&&m(c.type)&&f.call(q,c.from)&&(V.push({msg:c,sent:b.timeStamp}),ia());return 1},auth:function(a,b){var c=a.msg,g=c.id,d=c.creds;if(f.call(y,g)||f.call(u,g)||!m(c.channel))return 1;c.origin=b.origin;c=new ya(c,a.mid);f.call(k,"_evts")&&f.call(k._evts,"auth")&&k._evts.auth.length?(y[g]=c,h(c),d.length?k.fire.apply(k,["auth",c].concat(d)):k.fire("auth",c)):c.allow()},drop:function(a){a=a.msg;var b;f.call(q,a)?(b=q[a],ra(b),aa(b),f.call(x,a)?delete x[a]:W(b,O)):f.call(y,
a)&&y[a].ignore()}},wa={net:function(a){var b=a.joins;a=a.drops;var c,g,d,e,h={joins:[],drops:[]};for(d=b.length;d--;)g=b[d],c=new ea(g),Z(c),ja(c),t[c.channel]&&(delete g.bid,h.joins.push(g),e=1);for(d=a.length;d--;)g=a[d],b=g.id,f.call(u,b)&&(c=u[b],aa(c),k.fire("drop",c),t[c.channel]&&(h.drops.push(g),e=1));e&&v("net",h)},client:function(a){ma(a);k.fire("message",a)}},k={version:"0.0.0-alpha",protocol:"se-0",id:N,disabled:ga,network:"",pendingAuths:y,pendingRelay:null,destroy:function(){var a;
if(fa&&!K){K=1;for(a in q)q[a].drop();R(d,"message",sa);R(d,"storage",va);R(d,"unload",k.destroy);k.off();T(1);v("die",123);$||(s.removeItem("se-0-msg"),s.removeItem("se-0-net"))}},init:function(a){var b=4,c;if(!(fa||K||ga))if(R(d,"message",xa),m(a)&&"se-0"==a.substring(0,b)){if(b++,z=a.substring(b,a.indexOf("`",b)),b+=z.length+1,!isNaN(z)&&(z*=1,D=a.substring(b,a.indexOf("`",b))))I.cipher(a.substring(b+D.length+1)),I.decode(I.encode(D))===D&&(fa=1,k.network=D,ba||(ta=new RegExp('^{"key":'+z+',"mid":"[0-9a-f-]{36}","type":".+?","msg":.+}$')),
setTimeout(function(){var a;if(!K){a=s.getItem("se-0-net");if(m(a)){try{a=ca(a)}catch(b){s.removeItem("se-0-net")}if(S.isArray(a))for(c=a.length;c--;)Z(new ea(a[c]))}Q(d,"message",sa);Q(d,"storage",va);k.fire("initialize");K||(Q(d,"unload",k.destroy),v("ready",Fa))}},ha.round(75*L())))}else pa(function(){k.fire("error","invalid initialization token")})},on:function(a,b){m(a)&&"function"===typeof b&&(f.call(this,"_evts")||(this._evts={}),f.call(this._evts,a)||(this._evts[a]=[]),this._evts[a].push(b));
return this},off:function(a,b){var c,d,e=arguments.length;if(!f.call(this,"_evts")||!e)this._evts={};else if(m(a)&&f.call(this._evts,a)){c=this._evts[a];if("function"==typeof b)for(d=c.length;d--;)if(c[d]===b){c.splice(d,1);break}(2>e||!c.length)&&delete this._evts[a]}return this},fire:function(a){var b=this,c,d,e,k,h;if(m(a)&&f.call(b,"_evts")&&f.call(b._evts,a)&&(e=(d=b._evts[a]).length))for(c=Ea.call(arguments,1),h=c.length?function(a){a.apply(b,c)}:function(a){a.call(b)},k=0;k<e;k++)h(d[k]);return b}};
if(ga)return k;p(ya.prototype,{allow:function(){var a=this.client,b=a.id;Y(this);v("auth",{id:b,ok:!0,peers:F(a.channel)});var a=new da(a),b=a.id,c=a.channel;Z(a);f.call(J,c)||(J[c]={},t[c]=0);q[b]=J[c][b]=a;t[c]++;Ga++;W(a,x)},deny:function(a){Y(this);v("auth",{id:this.client.id,ok:!1,code:"string"===typeof a?a:""})},ignore:function(){Y(this)}});p(qa.prototype,{allow:function(){var a=this.msg,b=0,c=a.to,d=!c,h=q[a.from].channel,l=t[h],h=C[h];k.pendingRelay=null;if(1<h){var m;if((m=1<l)&&!(m=d))a:{m=
q;var n=c.length;if(m&&n)for(;n--;)if(f.call(m,c[n])){m=1;break a}m=void 0}m&&(ma(a),b=1);if(l=l<h){if(!d)a:{d=q;l=c.length;if(d&&l)for(;l--;)if(!f.call(d,c[l])){d=1;break a}d=void 0}l=d}l&&(H("client",a),b=1);b&&k.fire("message",a)}e()},deny:e,ignore:e});p(E.prototype,{drop:function(){return f.call(u,this.id)?(aa(this),!0):!1}});za=E.prototype.drop;da.prototype=new E;p(da.prototype,{drop:function(){return za.call(this)?(ra(this),W(this,O),!0):!1}});ea.prototype=new E;m(d._subetha)?k.init(d._subetha):
Q(d,"message",xa);return k}A?define(p):n?module.exports=p():d.SBridge||(d.SBridge=p())}("function"==typeof define,"undefined"!=typeof exports,localStorage,Array,Date,Math,this);