/* SubEtha-Bridge v0.0.3-alpha + Morus v1.0.0 | github.com/bemson | (c) 2014, APACHE & MIT */
!function(k,l,f,s){function g(){function g(){for(var b={},c=m.concat(),d,a,e,f=95;f--;)e=n(p()*f),a=f+32,d=c[e],b[a+"c"]=d,b[d]=a,c.splice(e,1);return b}function e(){this.randomize()}var h={},m=[],f,k=JSON.stringify,l=JSON.parse,p=Math.random,n=Math.round,q=/[ -~]/g,r=/^(\d+)({.+})$/;!function(){for(var b=95,c,d;b--;)c=b+32,d=String.fromCharCode(c),h[c+"c"]=m[b]=d,h[d]=c;f=m.join("")}();e.prototype.encode=function(b){var c=this.key,d=this.index,a;return b.replace(q,function(b){a=h[b];a-=32-d;a%=95;
a+=32;d++;return c[a+"c"]})};e.prototype.decode=function(b){var c=this.key,d=this.index,a;return b.replace(q,function(b){a=c[b];a-=32+d;0>a&&(a%=95)&&(a=95+a);a+=32;d++;return h[a+"c"]})};e.prototype.randomize=function(){this.key=g();this.index=n(95*p());return this};e.prototype.cipher=function(b){var c;return arguments.length?"string"==typeof b&&(c=r.exec(b))?(this.index=+c[1],this.key=l(c[2]),!0):!1:this.index+k(this.key)};e.genKey=g;e.ASCII=f;return e}k?define(g):l?module.exports=g():f.Morus||
(f.Morus=g())}("function"==typeof define,"undefined"!=typeof exports,this);
!function(ea,L,Ca,fa,M,ga,h,Ka){function w(){function x(a){for(var b=1,c,d;c=arguments[b];b++)for(d in c)e.call(c,d)&&(a[d]=c[d]);return a}function w(a){var b=16*E()|0;return("x"===a?b:b&3|8).toString(16)}function m(a){return a&&"string"===typeof a}function ha(){for(var a=[],b=~~(40*E());b--;)a.push(Da(~~(90*E())));return a.join("")}function ia(a){e.call(r,a)||(r[a]={},y[a]=0);return r[a]}function ja(a,b){n.setItem("se-0-msg",Ea+ka+F({type:a,bid:G,msg:b}))}function la(a,b){var c=0,d;if(!b){c=a.from;
if(!e.call(q,c))return;b=q[a.from].channel;c=!e.call(l,c)}N();d=p[b];if(!(c=!a.to&&(c&&d||!c&&1<d))&&(c=a.to))a:{c=a.to;for(d=c.length;d--;)if(e.call(l,c[d])){c=1;break a}c=0}c&&s("client",a)}function s(a,b,c){Fa(["se-0",z,B.encode(ha()+F({mid:"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(ma,w),type:a,sent:c||new M,msg:b})+ha())]);B.shift++}function na(a){var b=a.allow,c=a.deny,d=a.ignore,f=1;a.allow=function(){return f?(f=0,O(a,c,arguments),!0):!1};a.deny=function(){return f?(f=0,O(a,b,arguments),
!0):!1};a.ignore=function(){return f?(f=0,O(a,d,arguments),!0):!1}}function O(a,b,c){return c.length?b.apply(a,c):b.call(a)}function P(){Q=0;oa(pa())}function pa(){var a;!Q&&R.length&&(Q=1,a=new qa(R.shift()),e.call(g,"_evts")&&e.call(g._evts,"relay")&&g._evts.relay.length?(na(a),g.pendingRelay=a,g.fire("relay",a)):a.allow())}function ra(a){e.call(t,a.id)&&g.fire("join",a)}function S(a,b){b[a.id]=a;clearTimeout(T);T=setTimeout(N,5)}function N(a){var b=t,c=H,d=[],f=[],e,k,h;clearTimeout(T);t={};H=
{};for(e in b)k=b[e],d.push(k),ra(k);for(e in c)k=c[e],f.push({id:e,channel:k.channel}),g.fire("drop",k);if(d.length||f.length){c=[];for(h in r)for(e in b=r[h],b)c.push(b[e]);n.setItem("se-0-net",F(c));d={joins:d,drops:f};ja("net",d);a||s("net",d)}}function V(a){a=a.client.id;e.call(u,a)&&delete u[a]}function W(a,b){var c=a.id,d=a.channel;q[c]=(b||ia(d))[c]=a;y[d]++;X++;return a}function Y(a){var b=a.channel;a=a.id;delete q[a];X--;1===y[b]?(delete r[b],delete y[b]):(delete r[b][a],y[b]--)}function sa(a){var b=
a.id;a=a.channel;delete l[b];delete t[b];1===p[a]?(delete C[a],delete p[a]):(delete C[a][b],p[a]--)}function ta(a){var b=a.data,c=typeof b,d,f=0;ka=a.timeStamp;if(!Z&&"string"===c)if(ua.test(b))try{b=$(b),f=1}catch(g){return}else return;else if("object"!==c)return;if((f||b.key===v&&m(b.mid)&&e.call(b,"msg"))&&e.call(va,d=b.type))va[d](b,a)}function wa(a){var b=a.newValue;if("se-0-msg"==a.key&&"string"==typeof b&&Ga.test(b)){b=b.substring(b.indexOf("{"));try{b=$(b)}catch(c){return}if("object"===typeof b&&
e.call(b,"msg")&&e.call(xa,b.type))xa[b.type](b.msg)}}function ya(a){g.init(a.data)}function za(){}function Aa(a,b){this.client=a;this.credentials=a.creds;this.mid=b;delete a.creds}function qa(a){this.sent=a.sent;this.msg=a.msg}function A(a){a&&(this.id=a.id,this.channel=a.channel,this.origin=a.origin)}function aa(a){A.call(this,a);this.start=new M;this.bid=G}function ba(a){A.call(this,a);this.start=new M(a.start);this.bid=a.bid}var B=new (L||ea?require("morus"):h.Morus),F=JSON.stringify,$=JSON.parse,
n=Ca,E=ga.random,Da=String.fromCharCode,Ha=fa.prototype.slice,e=Object.prototype.hasOwnProperty,Ba,ma=/[xy]/g,G="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(ma,w),z,ca=0,D=0,ka,I=h.parent,v,ua,Ga=/se-0`[0-9a-f-]{36}`\d+\{.+\}$/,Ia=location.origin||location.protocol+"//"+(location.port?location.port+":":"")+location.hostname,Ea="se-0`"+G+"`",da=I===h||"function"!=typeof I.postMessage||"object"!=typeof n||"function"!=typeof n.getItem||"function"!=typeof n.setItem,q={},X=0,r={},y={},u={},l={},Ja=0,
C={},p={},H={},t={},T,R=[],Q=0,Z=!!function(){var a=1;try{h.postMessage({toString:function(){a=0}},"*")}catch(b){}return a}(),Fa=Z?function(a){I.postMessage(a,"*")}:function(a){I.postMessage(F(a),"*")},oa="function"===typeof setImmediate&&setImmediate||L&&process.nextTick||function(a){setTimeout(a,0)},J=h.attachEvent?function(a,b,c){a.attachEvent("on"+b,c)}:function(a,b,c){a.addEventListener(b,c,!1)},K=h.attachEvent?function(a,b,c){a.detachEvent("on"+b,c)}:function(a,b,c){a.removeEventListener(b,
c,!1)},va={client:function(a,b){var c=a.msg;"object"===typeof c&&m(c.type)&&e.call(l,c.from)&&(R.push({msg:c,sent:b.timeStamp}),pa());return 1},auth:function(a,b){var c=a.msg,d=c.id,f=c.creds;if(e.call(u,d)||e.call(q,d)||!m(c.channel))return 1;c.origin=b.origin;c=new Aa(c,a.mid);e.call(g,"_evts")&&e.call(g._evts,"auth")&&g._evts.auth.length?(u[d]=c,na(c),f.length?g.fire.apply(g,["auth",c].concat(f)):g.fire("auth",c)):c.allow()},drop:function(a){a=a.msg;var b;e.call(l,a)?(b=l[a],sa(b),Y(b),e.call(t,
a)?delete t[a]:S(b,H)):e.call(u,a)&&u[a].ignore()}},xa={net:function(a){var b=a.joins;a=a.drops;var c,d,f,U,k={joins:[],drops:[]};for(f=b.length;f--;)d=b[f],c=new ba(d),W(c),ra(c),p[c.channel]&&(delete d.bid,k.joins.push(d),U=1);for(f=a.length;f--;)d=a[f],b=d.id,e.call(q,b)&&(c=q[b],Y(c),g.fire("drop",c),p[c.channel]&&(k.drops.push(d),U=1));U&&s("net",k)},client:function(a){la(a);g.fire("message",a)}},g={version:"0.0.0-alpha",protocol:"se-0",id:G,disabled:da,network:"",pendingAuths:u,pendingRelay:null,
destroy:function(){var a;if(ca&&!D){D=1;for(a in l)l[a].drop();K(h,"message",ta);K(h,"storage",wa);K(h,"unload",g.destroy);g.off();N(1);s("die",123);X||(n.removeItem("se-0-msg"),n.removeItem("se-0-net"))}},init:function(a){var b=4,c;if(!(ca||D||da))if(K(h,"message",ya),m(a)&&"se-0"==a.substring(0,b)){if(b++,v=a.substring(b,a.indexOf("`",b)),b+=v.length+1,!isNaN(v)&&(v*=1,z=a.substring(b,a.indexOf("`",b))))B.cipher(a.substring(b+z.length+1)),B.decode(B.encode(z))===z&&(ca=1,g.network=z,Z||(ua=new RegExp('^{"key":'+
v+',"mid":"[0-9a-f-]{36}","type":".+?","msg":.+}$')),setTimeout(function(){var a;if(!D){a=n.getItem("se-0-net");if(m(a)){try{a=$(a)}catch(b){n.removeItem("se-0-net")}if(fa.isArray(a))for(c=a.length;c--;)W(new ba(a[c]))}J(h,"message",ta);J(h,"storage",wa);g.fire("initialize");D||(J(h,"unload",g.destroy),s("ready",Ia))}},ga.round(100*E())))}else oa(function(){g.fire("error","invalid initialization token")})}};x(za.prototype,{on:function(a,b,c){m(a)&&"function"===typeof b&&(e.call(this,"_evts")||(this._evts=
{}),e.call(this._evts,a)||(this._evts[a]=[]),this._evts[a].push({cb:b,ctx:c||this,fctx:2<arguments.length}));return this},off:function(a,b,c){var d,f,g,k=0,h=3>arguments.length,l;if(!e.call(this,"_evts")||!arguments.length)this._evts={};else if(m(a)&&e.call(this._evts,a)){if(b){d=this._evts[a];for(f=this._evts[a]=[];g=d[k];++k)(g.cb!==b||h&&g.fctx||g.ctx!==c)&&f.push(g);f.length||(l=1)}else l=1;l&&delete this._evts[a]}return this},fire:function(a){var b,c,d,f,g;if(m(a)&&e.call(this,"_evts")&&e.call(this._evts,
a)&&(c=this._evts[a]).length)for(b=Ha.call(arguments,1),g=b.length?function(a){a.cb.apply(a.ctx,b)}:function(a){a.cb.call(a.ctx)},d=c.length,f=0;f<d;++f)g(c[f]);return this}});x(g,za.prototype);if(da)return g;x(Aa.prototype,{allow:function(){var a=this.client,b=a.id;V(this);s("auth",{id:b,ok:!0,peers:ia(a.channel)});var a=new aa(a),b=a.id,c=a.channel;W(a);e.call(C,c)||(C[c]={},p[c]=0);l[b]=C[c][b]=a;p[c]++;Ja++;S(a,t)},deny:function(a){V(this);s("auth",{id:this.client.id,ok:!1,code:"string"===typeof a?
a:""})},ignore:function(){V(this)}});x(qa.prototype,{allow:function(){var a=this.msg,b=0,c=a.to,d=!c,f=l[a.from].channel,h=p[f],f=y[f];g.pendingRelay=null;if(1<f){var k;if((k=1<h)&&!(k=d))a:{k=l;var m=c.length;if(k&&m)for(;m--;)if(e.call(k,c[m])){k=1;break a}k=void 0}k&&(la(a),b=1);if(h=h<f){if(!d)a:{d=l;h=c.length;if(d&&h)for(;h--;)if(!e.call(d,c[h])){d=1;break a}d=void 0}h=d}h&&(ja("client",a),b=1);b&&g.fire("message",a)}P()},deny:P,ignore:P});x(A.prototype,{drop:function(){return e.call(q,this.id)?
(Y(this),!0):!1}});Ba=A.prototype.drop;aa.prototype=new A;x(aa.prototype,{drop:function(){return Ba.call(this)?(sa(this),S(this,H),!0):!1}});ba.prototype=new A;m(h._subetha)?g.init(h._subetha):J(h,"message",ya);return g}ea?define(w):L?module.exports=w():h.SBridge||(h.SBridge=w())}("function"==typeof define,"undefined"!=typeof exports,localStorage,Array,Date,Math,this);